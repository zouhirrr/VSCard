// استبدل وظيفة generateVCard في الكود السابق بهذا التحديث الجوهري:

function generateVCard() {
    const name = document.getElementById('v-name').value || "اسم المستخدم";
    const title = document.getElementById('v-title').value || "المسمى الوظيفي";
    const phone = document.getElementById('v-phone').value || "";
    const email = document.getElementById('v-email').value || "";
    const web = document.getElementById('v-web').value || "";
    const c1 = document.getElementById('c1').value;
    const c2 = document.getElementById('c2').value;
    const isTrans = document.getElementById('is-trans').checked;

    // الحل السحري: إضافة CHARSET=UTF-8 لكل حقل يحتوي على نص عربي
    const vCardData = `BEGIN:VCARD
VERSION:3.0
FN;CHARSET=UTF-8:${name}
TITLE;CHARSET=UTF-8:${title}
TEL;TYPE=CELL:${phone}
EMAIL:${email}
URL:${web}
END:VCARD`;

    // تحديث الواجهة المرئية
    document.getElementById('name-display').innerText = name;
    document.getElementById('title-display').innerText = title;
    
    document.getElementById('vcard-frame').className = isTrans ? 'designer-mode' : '';
    document.getElementById('name-display').style.color = isTrans ? c1 : "#0f172a";

    // تحديث كود الـ QR بالبيانات الجديدة المرمزة صحيحة
    qr.update({
        data: vCardData,
        dotsOptions: { 
            gradient: { 
                type: "linear", 
                colorStops: [{ offset: 0, color: c1 }, { offset: 1, color: c2 }] 
            } 
        },
        backgroundOptions: { color: isTrans ? "transparent" : "#ffffff" },
        cornersSquareOptions: { color: c1 }
    });
}
